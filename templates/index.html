<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Помощник по диагностике промышленных неисправностей (на основе LLM)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            width: 100%;
            margin: 30px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        h1, h2 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
        }
        h1 {
            font-size: 2.2em;
        }
        h2 {
            font-size: 1.4em;
            color: #007bff;
        }
        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 0.95em;
        }
        .input-section input[type="text"],
        .input-section input[type="file"],
        .input-section textarea {
            width: calc(100% - 24px); /* Account for padding */
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box; /* Include padding in width */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-section input[type="text"]:focus,
        .input-section input[type="file"]:focus,
        .input-section textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
        }
        .input-section textarea {
            min-height: 100px;
            resize: vertical;
        }
        .input-section button, .link-button {
            display: inline-block; /* Changed for side-by-side */
            width: auto; /* Fit content */
            padding: 12px 20px;
            background-color: #007bff;
            color: white !important; /* Ensure text is white */
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-decoration: none; /* For <a> styled as button */
            text-align: center;
            margin-right: 10px; /* Space between buttons */
        }
        .input-section button:hover, .link-button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .input-section button:active, .link-button:active {
            transform: translateY(0);
        }
        .button-container {
            display: flex; /* Align buttons in a row */
            justify-content: flex-start; /* Align to the left */
            margin-top: 10px;
        }
        .output-section {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid #eee;
        }
        .output-section h3 {
            color: #0056b3;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.3em;
        }
        .output-box {
            background-color: #e9f5ff;
            border: 1px solid #cce5ff;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 150px;
            font-size: 0.95em;
            color: #333;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .error-message {
            color: #D8000C;
            background-color: #FFD2D2;
            border: 1px solid #D8000C;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .disclaimer {
            font-size: 0.85em;
            color: #777;
            text-align: center;
            margin-top: 20px;
            padding: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Помощник по диагностике промышленных неисправностей</h1>
        <h2>Интерактивный метод на основе больших языковых моделей</h2>

        <div class="input-section">
            <label for="systemPrompt">Системная инструкция для ИИ (задайте роль, правила, язык ответа и т.д.):</label>
            <textarea id="systemPrompt" name="systemPrompt" placeholder="Пример: Вы — опытный инженер по техническому обслуживанию промышленного оборудования...">You are a senior industrial equipment maintenance expert and fault diagnosis engineer. Please accurately diagnose potential fault causes based on the equipment and fault symptoms provided by the user, any attached files (like images or data logs), AND **leveraging the 'Related Knowledge Base Information' provided below**. Then provide detailed, actionable diagnostic steps and solutions.

Please strictly adhere to the following rules:
1.  **Reference Knowledge Base:** Prioritize using the "Related Knowledge Base Information" for diagnosis. If the knowledge base does not contain a direct match, infer based on your general professional knowledge and any provided files.
2.  **Analyze Files:** If a file is attached (e.g., an image of the fault, sensor readings, error logs), incorporate its information into your diagnosis.
3.  **Professionalism:** Use professional terminology from the industrial domain.
4.  **Detail:** List all possible fault causes, diagnostic steps, and repair measures as comprehensively as possible.
5.  **Structure:** Your response should be clearly divided into four sections: "Diagnosis Result," "Possible Causes," "Diagnostic Steps," and "Solution."
6.  **Ask for More Information:** If the information (text or file) is insufficient, proactively ask for more details.
7.  **Language:** Respond in Russian.
            </textarea>

            <label for="equipmentName">Название оборудования:</label>
            <input type="text" id="equipmentName" name="equipmentName" placeholder="Введите название оборудования" value="Гидравлический пресс">

            <label for="faultSymptoms">Подробно опишите симптомы неисправности:</label>
            <textarea id="faultSymptoms" name="faultSymptoms" placeholder="например, 'Насос издает громкий скрежет...'">Пресс не развивает полного давления, медленно движется рабочий цилиндр, слышен посторонний шум в районе насоса.</textarea>

            <label for="faultFile">Загрузить файл с информацией о неисправности (изображение, лог и т.д.):</label>
            <input type="file" id="faultFile" name="faultFile">

            <div class="button-container">
                <button type="button" onclick="diagnoseFault()">Диагностировать неисправность</button>
                <a href="https://docs.google.com/spreadsheets/d/1aBkixQZAWEGN_bDoAbeQ8tSd5fllKrP8tCizhIo79DY/edit?gid=104964265#gid=104964265" target="_blank" class="link-button">Изменить базу знаний</a>
            </div>
        </div>

        <div class="output-section">
            <h3>Результат диагностики</h3>
            <div id="diagnosisOutput" class="output-box">
                Здесь появится ваш диагноз.
            </div>
        </div>
         <div class="disclaimer">
            Обратите внимание: этот инструмент предоставляет предварительные рекомендации...
        </div>
    </div>

    <script>
        async function diagnoseFault() {
            const systemPrompt = document.getElementById('systemPrompt').value.trim();
            const equipment = document.getElementById('equipmentName').value.trim();
            const symptoms = document.getElementById('faultSymptoms').value.trim();
            const faultFile = document.getElementById('faultFile').files[0]; // Get the file object
            const outputDiv = document.getElementById('diagnosisOutput');

            if (!systemPrompt || !equipment || !symptoms) {
                outputDiv.innerHTML = `<p class="error-message">Пожалуйста, заполните все обязательные текстовые поля: системную инструкцию, название оборудования и симптомы неисправности.</p>`;
                return;
            }

            outputDiv.innerHTML = "Диагностика... Пожалуйста, подождите.";

            const formData = new FormData();
            formData.append('system_prompt', systemPrompt);
            formData.append('equipment', equipment);
            formData.append('symptoms', symptoms);
            if (faultFile) {
                formData.append('fault_file', faultFile);
            }

            try {
                // We are not setting Content-Type header manually for FormData.
                // The browser will set it to multipart/form-data with the correct boundary.
                const response = await fetch('/chat', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { error: `Ошибка сервера: ${response.status}`, details: await response.text() };
                    }
                    console.error('Error during diagnosis API call:', errorData);
                    let errorMsg = `Произошла ошибка: ${errorData.error || response.statusText}`;
                    if (errorData.details && errorData.details !== errorData.error) {
                        errorMsg += `<br>Детали: ${errorData.details}`;
                    }
                    outputDiv.innerHTML = `<p class="error-message">${errorMsg}</p>`;
                    return;
                }

                const data = await response.json();

                if (data.error) {
                     outputDiv.innerHTML = `<p class="error-message">Ошибка от сервера: ${data.error}${data.details ? '<br>Детали: ' + data.details : ''}</p>`;
                } else {
                    let formattedOutput = "";
                    if (data.explanation) {
                        let explanationHtml = data.explanation.replace(/\n/g, '<br>');
                        explanationHtml = explanationHtml.replace(/\*\*(Результат диагностики|Возможные причины|Диагностические шаги|Diagnosis Result|Possible Causes|Diagnostic Steps):\*\*/g, '<strong>$1:</strong>');
                        formattedOutput += `<div>${explanationHtml}</div>`;
                    } else {
                        formattedOutput += `<p>Объяснение не предоставлено.</p>`;
                    }

                    if (data.control_action) {
                         let controlActionHtml = data.control_action.replace(/\n/g, '<br>');
                         controlActionHtml = controlActionHtml.replace(/\*\*(Решение|Solution|Control Action):\*\*/g, '<strong>$1:</strong>');
                        formattedOutput += `<br><div><strong>Решение/Контрольные действия:</strong><br>${controlActionHtml}</div>`;
                    } else {
                        formattedOutput += `<p>Решение/Контрольные действия не предоставлены.</p>`;
                    }
                    outputDiv.innerHTML = formattedOutput;
                }

            } catch (error) {
                console.error('Client-side error during diagnosis API call:', error);
                outputDiv.innerHTML = `<p class="error-message">Произошла ошибка на стороне клиента при вызове API диагностики. Проверьте консоль для деталей.</p>`;
            }
        }
    </script>
</body>
</html>